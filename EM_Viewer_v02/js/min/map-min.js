var viewer=new OpenSeadragon({id:"map",prefixUrl:"/emdb/js/vendor/openseadragon/images/",tileSources:"/emdb/images/openseadragon/emdb1.dzi",constrainDuringPan:!0,showNavigator:!0,navigatorId:"navigator-inner",navigatorAutoFade:!1,defaultZoomLevel:.7,minZoomLevel:.7,maxZoomLevel:50});$(function(){var e,t=!1;viewer.addHandler("tile-drawn",function(){t||(clearTimeout(e),e=setTimeout(function(){t=!0;var e=$("#map").width(),a=$("#map").height(),n=viewer.viewport.pointFromPixel(new OpenSeadragon.Point(e,a)),i=n.x,r=n.y,o=viewer.viewport.getMinZoom(),s=viewer.viewport.getMaxZoom(),d=viewer.viewport.viewportToImageZoom(o),p=viewer.viewport.viewportToImageZoom(s),l=viewer.source.width/160,v=viewer.source.height/160,c=l*i,w=v*r,g={top:0,right:0,bottom:0,left:50},u=$("#map").width(),m=$("#map").height(),x=[{x:0,y:0},{x:c,y:w}],f=d3.scale.linear().domain([0,d3.max(x,function(e){return e.x})]).range([0,u]),h=d3.scale.linear().domain([0,d3.max(x,function(e){return e.y})]).range([m,0]),y=d3.svg.axis().scale(f).orient("bottom").innerTickSize(-m).outerTickSize(0).tickPadding(10),T=d3.svg.axis().scale(h).orient("left").innerTickSize(-u).outerTickSize(0).tickPadding(10),b=d3.svg.line().x(function(e){return f(e.x)}).y(function(e){return h(e.y)}),k=d3.select("body").append("svg").attr("width",u+g.left+g.right).attr("height",m+g.top+g.bottom).append("g").attr("transform","translate("+g.left+","+g.top+")");k.append("g").attr("class","x axis").attr("transform","translate(0,"+m+")").call(y).append("text").attr("x",u+16).attr("y",34).style("text-anchor","end").style("fill","white").style("font-size","12px").text("(μm)"),k.append("g").attr("class","y axis").call(T).append("text").attr("x",-40).attr("y",-10).style("text-anchor","start").style("fill","white").style("font-size","12px").text("(μm)");var z=300,S=50,P=d3.select("#range").append("svg").attr("width",z).attr("height",S),M=d3.scale.linear().domain([d,p]).range([0,220]);P.append("g").attr("class","axis").attr("transform","translate(10, 0)").call(d3.svg.axis().outerTickSize(12).innerTickSize(12).scale(M).ticks(5).tickFormat(function(e){return"x "+e})).append("text").attr("x",230).attr("y",22).style("text-anchor","start").style("fill","white").text("");var O='<div id="range-area"><div id="range-bar"></div></div>';$(O).appendTo("#range"),console.log(viewer),$(window).on("wheel",function(e){e.preventDefault()});var Z=[],C=!1,F=!1,I=!1;$("#pin").on("mousedown",function(){$(this).toggleClass("on"),I=$(this).hasClass("on"),viewer.gestureSettingsMouse.clickToZoom=!I});var X=!1,H,D,B,L,Y,j,A,E,N,U,q,G=!1;viewer.addHandler("canvas-drag",function(){G=!0}),viewer.addHandler("canvas-press",function(e){G=!1}),viewer.addHandler("canvas-click",function(e){if(I&&!G){var t=new Date;t=t.getTime();var a=new Image;a.src="./images/pin.svg",$(a).addClass("pin "+t),document.body.appendChild(a);var n=e.position,i=viewer.viewport.pointFromPixel(n);viewer.addOverlay(a,i,"BOTTOM"),X=!1;var r=!1,o=!1,s=!1,d=document.createElement("div");$(d).addClass("menu "+t).append('<input type="text" class="text" placeholder="label">').append('<div class="position-x">x:<span class="number-x">'+Math.round(1e3*i.x)/1e3+"</span></div>").append('<div class="position-y">y:<span class="number-y">'+Math.round(1e3*i.y)/1e3+"</span></div>"),viewer.addOverlay(d,i,"BOTTOM"),$(a).add($(d)).on({"mouseover.pinMenu":function(e){o=!0,X||s||setTimeout(function(){o&&(s=!0,$(d).addClass("show"))},300)},"mouseleave.pinMenu":function(){o=!1,X||setTimeout(function(){o||(s=!1,$(d).removeClass("show"))},300)},"mousedown.pinMenu":function(e){e.stopPropagation()}}),$(a).on({"mousedown.pin":function(e){I&&1===e.buttons&&(X=!0,B=$(a).offset().left-a.width/2,L=$(a).offset().top,H=e.pageX,D=e.pageY,Y=!1,E=a,N=d,j=$(d).find(".number-x"),A=$(d).find(".number-y"),U=a.width,q=a.height)}})}}),$(window).on({"mousemove.pin":function(e){if(e.preventDefault(),X){Y=!0;var t=B+e.pageX-H,a=L+e.pageY-D,n=new OpenSeadragon.Point(t,a),i=viewer.viewport.pointFromPixel(n);viewer.updateOverlay(E,i),viewer.updateOverlay(N,i),j.text(Math.round(1e3*i.x)/1e3),A.text(Math.round(1e3*i.y)/1e3)}},"mouseup.pin":function(e){X=!1}});var J=!1,B=0,K,Q,R=$("#range-area").width(),V=$("#range-bar"),W=$("#range-left-area"),_;V.on("mousedown.range",function(e){J=!0,H=e.pageX,K=viewer.viewport.getZoom(),_=viewer.viewport.getCenter()}),$(window).on({"mousemove.range":function(e){J&&(Q=B+e.pageX-H,Q=0>Q?0:Q>R?R:Q,V.css({transform:"translateX("+Q+"px)"}),K=o+Q/R*(s-o),K=o>K?o:K>s?s:K,viewer.viewport.zoomTo(K,_,!1))},"mouseup.range":function(e){J=!1,B=Q}}),viewer.addHandler("zoom",function(){ee()});var ee=function(){var t=viewer.source.width/160,n=viewer.source.height/160,i=viewer.viewport.getBounds(),r={x:i.x*t,y:i.y*n},d={x:i.width*t,y:i.height*n},p=viewer.viewport.getZoom(),l=viewer.viewport.viewportToImageZoom(p),v=viewer.viewport.pointFromPixel(new OpenSeadragon.Point(e,a)),c=viewer.viewport.viewportToImageCoordinates(v),w=v.x*p,g=v.y*p,t=viewer.source.width*l;n=viewer.source.height*l;var u=t*w,m=n*g;if(!J){var x=viewer.viewport.getCenter();B=R*p/(s-o),V.css({transform:"translateX("+B+"px)"})}$("body > svg").remove();var f={top:0,right:0,bottom:0,left:50},h=$("#map").width(),y=$("#map").height(),T=[{x:0,y:0},{x:d.x,y:d.y}],b=d3.scale.linear().domain([T[0].x,T[1].x]).range([0,h]),k=d3.scale.linear().domain([T[0].y,T[1].y]).range([y,0]),z=d3.svg.axis().scale(b).orient("bottom").innerTickSize(-y).outerTickSize(0).tickPadding(10),S=d3.svg.axis().scale(k).orient("left").innerTickSize(-h).outerTickSize(0).tickPadding(10),P=d3.svg.line().x(function(e){return b(e.x)}).y(function(e){return k(e.y)}),M=d3.select("body").append("svg").attr("width",h+f.left+f.right).attr("height",y+f.top+f.bottom).append("g").attr("transform","translate("+f.left+","+f.top+")");M.append("g").attr("class","x axis").attr("transform","translate(0,"+y+")").call(z).append("text").attr("x",h+16).attr("y",34).style("text-anchor","end").style("fill","white").style("font-size","12px").text("(μm)"),M.append("g").attr("class","y axis").call(S).append("text").attr("x",-40).attr("y",-10).style("text-anchor","start").style("fill","white").style("font-size","12px").text("(μm)")}},300))}),$(window).on("contextmenu",function(){return!1})});